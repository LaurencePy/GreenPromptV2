(()=>{"use strict";function t(t){return t?t.trim().split(/\s+|(?=[,.!?:;])/).filter(Boolean):[]}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("options-btn");e&&e.addEventListener("click",(()=>{chrome.runtime.openOptionsPage()}));const n=document.getElementById("prompt-input"),o=document.getElementById("optimize-btn"),r=document.getElementById("status"),i=(document.getElementById("optimized-output"),document.getElementById("input-tokens")),s=document.getElementById("output-tokens");if(!o)return console.error("Element with ID 'optimize-btn' not found!"),void(r&&(r.textContent="Error: Optimize button not found in HTML."));r&&(r.textContent=""),o.disabled=!1,o.addEventListener("click",(async()=>{const e=n.value.trim();e?(r.textContent="Getting API Key...",o.disabled=!0,chrome.storage.sync.get("hfApiKey",(async a=>{const l=a.hfApiKey;if(!l)return r.textContent="Hugging Face API Key not set. Please set it in the settings.",void(o.disabled=!1);r.textContent="Optimizing...";try{const o=await async function(e,n){const o=document.getElementById("status"),r=t(e).length,i={inputs:`Rewrite the following prompt to be as short as possible without changing its meaning. Remove all politeness markers and unnecessary words.\nReturn ONLY the rewritten prompt, with NO extra words, explanations, or quotes.\nInput prompt: """${e}"""`,parameters:{max_new_tokens:60,temperature:.1,do_sample:!1,early_stopping:!0}};o&&(o.textContent="Calling model...");const s=await fetch("https://api-inference.huggingface.co/models/mistralai/Mixtral-8x7B-Instruct-v0.1",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify(i)});if(!s.ok){const t=await s.text();console.error(`Hugging Face API Error (${s.status}): ${s.statusText}`,t);let e="API request failed.";try{const n=JSON.parse(t);n.error?e=n.error:n.detail&&(e=n.detail)}catch(n){e=t.substring(0,200)}throw new Error(`Hugging Face API error (${s.status}). Details: ${e}`)}const a=await s.json();if(Array.isArray(a)&&a.length>0){const e=a[0]?.generated_text||a[0]?.summary_text;if(e){const n=function(t){if(!t)return"";const e=t.trim().split("\n");let n="";for(let t=e.length-1;t>=0;t--){const o=e[t].trim();if(o){n=o;break}}return n=n.replace(/^.*?:\s*/,""),n=n.replace(/^["']+|["']+$/g,""),n.trim()}(e);return{rewrittenText:n,inputTokens:r,outputTokens:t(n).length}}}return console.warn("API response was not in the expected format:",a),null}(e,l);if(!o||!o.rewrittenText)throw new Error("The API did not return a valid rewritten prompt. It might be loading. Please try again in a moment.");n.value=o.rewrittenText,await navigator.clipboard.writeText(o.rewrittenText),i.textContent=o.inputTokens,s.textContent=o.outputTokens,Math.max(0,o.inputTokens-o.outputTokens),localStorage.setItem("lastPrompt",o.rewrittenText),r.textContent="Optimized & copied!"}catch(t){console.error("An error occurred during optimization:",t),r.textContent=`Error: ${t.message}`}finally{o.disabled=!1}}))):r.textContent="Please enter a prompt"}))}))})();